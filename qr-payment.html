<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payment | Exam Registration</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container mt-5 col-md-6">
  <div class="card p-4">
    <h3 class="text-center mb-3">Payment Module</h3>
    <p class="text-center">Selected Subject: <b id="subjectName"></b></p>

    <form onsubmit="return showScanner(event)" id="paymentForm">
      
      <div class="mb-3">
        <label>Full Name</label>
        <input type="text" class="form-control" id="fullName" readonly>
      </div>

      <div class="mb-3">
        <label>Roll Number</label>
        <input type="text" class="form-control" id="rollNum" readonly>
      </div>

      <div class="mb-3">
        <label>Email</label>
        <input type="email" class="form-control" id="emailId" readonly>
      </div>

      <hr>

      <div class="mb-3">
        <label>Amount to Pay</label>
        <input type="text" class="form-control" value="₹500" readonly style="font-weight: bold; text-align: center;">
      </div>

      <button class="btn btn-custom w-100" type="submit">Pay ₹500</button>
    </form>

    <!-- Scanner Section -->
    <div id="scannerSection" class="scanner-section mt-4 text-center" style="display: none;">
      <h5>Scan to Pay ₹500</h5>
      <img id="qrCode" src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=upi://pay?pa=test@upi&pn=ExamFees&am=500&tn=ExamRegistration" 
           alt="QR Code" class="qr-code my-3" style="width: 250px; height: 250px; border: 2px solid #007bff; padding: 10px; border-radius: 10px;">
      <p class="text-muted">Scan this QR code using any UPI app (Google Pay, Paytm, PhonePe, etc.)</p>
      <p><strong>Fixed Amount: ₹500</strong></p>

      <div class="mb-3 mt-4">
        <label>Enter Transaction ID</label>
        <input type="text" id="txnId" class="form-control" placeholder="Enter your UPI transaction ID" required>
      </div>

      <button class="btn btn-success w-100" onclick="submitTxn()">Submit</button>
      <button class="btn btn-secondary w-100 mt-2" onclick="goBack()">Back</button>
    </div>

  </div>
</div>

<script>
function loadUserDetails() {
  const user = JSON.parse(localStorage.getItem("user"));
  if (user) {
    document.getElementById("fullName").value = user.name || "";
    document.getElementById("rollNum").value = user.rollNumber || "";
    document.getElementById("emailId").value = user.email || "";
  }
}

function showScanner(event){
  event.preventDefault();
  document.getElementById("paymentForm").style.display = "none";
  document.getElementById("scannerSection").style.display = "block";
}

function submitTxn(){
  const txnId = document.getElementById("txnId").value.trim();
  if(txnId === ""){
    alert("Please enter your transaction ID.");
    return;
  }
  
  const user = JSON.parse(localStorage.getItem("user"));
  const examId = localStorage.getItem("examId");
  const userId = localStorage.getItem("userId");
  
  // Save payment to backend
  fetch('http://localhost:5000/api/payments/create', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      userId: userId,
      examId: examId,
      transactionId: txnId,
      cardLastDigits: user.rollNumber
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.payment) {
      localStorage.setItem("transactionId", txnId);
      localStorage.setItem("transactionAmount", "500");
      localStorage.setItem("transactionDate", new Date().toLocaleString());
      
      alert("Payment confirmed! Transaction ID: " + txnId + "\nYou are registered for the exam.");
      window.location.href = "dashboard.html";
    } else {
      alert(data.message || "Payment failed!");
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Failed to process payment');
  });
}

function goBack(){
  document.getElementById("paymentForm").style.display = "block";
  document.getElementById("scannerSection").style.display = "none";
  document.getElementById("txnId").value = "";
}

window.onload = () => {
  document.getElementById("subjectName").innerText = localStorage.getItem("selectedSubject") || "None";
  loadUserDetails();
}
</script>

</body>
</html>
